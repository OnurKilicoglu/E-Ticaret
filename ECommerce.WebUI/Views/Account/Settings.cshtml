@model ECommerce.WebUI.Models.UserSettingsViewModel

@{
    ViewData["Title"] = "Account Settings";
}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="bg-light py-2">
    <div class="container">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
            <li class="breadcrumb-item"><a asp-controller="Account" asp-action="Profile">My Account</a></li>
            <li class="breadcrumb-item active" aria-current="page">Settings</li>
        </ol>
    </div>
</nav>

<div class="container my-5">
    <div class="row">
        <!-- Account Sidebar -->
        <div class="col-lg-3 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h6 class="card-title mb-0">
                        <i class="bi bi-person-circle me-2"></i>My Account
                    </h6>
                </div>
                <div class="list-group list-group-flush">
                    <a asp-controller="Account" asp-action="Profile" class="list-group-item list-group-item-action">
                        <i class="bi bi-person me-2"></i>Profile
                    </a>
                    <a asp-controller="Account" asp-action="Orders" class="list-group-item list-group-item-action">
                        <i class="bi bi-bag me-2"></i>My Orders
                    </a>
                    <a asp-controller="Account" asp-action="Wishlist" class="list-group-item list-group-item-action">
                        <i class="bi bi-heart me-2"></i>Wishlist
                    </a>
                    <a asp-controller="Account" asp-action="Addresses" class="list-group-item list-group-item-action">
                        <i class="bi bi-geo-alt me-2"></i>Addresses
                    </a>
                    <a asp-controller="Account" asp-action="Settings" class="list-group-item list-group-item-action active">
                        <i class="bi bi-gear me-2"></i>Settings
                    </a>
                </div>
            </div>
        </div>

        <!-- Settings Content -->
        <div class="col-lg-9">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-1">Account Settings</h2>
                    <p class="text-muted mb-0">Manage your account preferences and privacy settings</p>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" id="resetBtn">
                        <i class="bi bi-arrow-clockwise me-1"></i>Reset
                    </button>
                    <button type="submit" form="settingsForm" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Save Changes
                    </button>
                </div>
            </div>

            <form asp-action="Settings" method="post" id="settingsForm">
                @Html.AntiForgeryToken()
                
                <!-- Personal Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-person me-2"></i>Personal Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="FirstName" class="form-label">First Name</label>
                                <input asp-for="FirstName" class="form-control" placeholder="Enter your first name">
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="LastName" class="form-label">Last Name</label>
                                <input asp-for="LastName" class="form-control" placeholder="Enter your last name">
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Email" class="form-label">Email Address</label>
                                <div class="input-group">
                                    <input asp-for="Email" class="form-control" placeholder="Enter your email" readonly>
                                    <span class="input-group-text">
                                        @if (Model.IsEmailVerified)
                                        {
                                            <i class="bi bi-check-circle-fill text-success" title="Verified"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-exclamation-circle-fill text-warning" title="Not verified"></i>
                                        }
                                    </span>
                                </div>
                                <div class="form-text">Email cannot be changed. Contact support if needed.</div>
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Phone" class="form-label">Phone Number</label>
                                <div class="input-group">
                                    <input asp-for="Phone" class="form-control" placeholder="Enter your phone number">
                                    <span class="input-group-text">
                                        @if (Model.IsPhoneVerified)
                                        {
                                            <i class="bi bi-check-circle-fill text-success" title="Verified"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-exclamation-circle-fill text-warning" title="Not verified"></i>
                                        }
                                    </span>
                                </div>
                                <span asp-validation-for="Phone" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="DateOfBirth" class="form-label">Date of Birth</label>
                                <input asp-for="DateOfBirth" type="date" class="form-control">
                                <span asp-validation-for="DateOfBirth" class="text-danger"></span>
                            </div>
                            <div class="col-md-6">
                                <label asp-for="Gender" class="form-label">Gender</label>
                                <select asp-for="Gender" class="form-select">
                                    <option value="">Prefer not to say</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                </select>
                                <span asp-validation-for="Gender" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notification Preferences -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-bell me-2"></i>Notification Preferences
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input asp-for="EmailNotifications" class="form-check-input" type="checkbox">
                                    <label asp-for="EmailNotifications" class="form-check-label">
                                        <strong>Email Notifications</strong>
                                        <br><small class="text-muted">Receive important updates via email</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input asp-for="SmsNotifications" class="form-check-input" type="checkbox">
                                    <label asp-for="SmsNotifications" class="form-check-label">
                                        <strong>SMS Notifications</strong>
                                        <br><small class="text-muted">Receive urgent notifications via SMS</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input asp-for="OrderUpdates" class="form-check-input" type="checkbox">
                                    <label asp-for="OrderUpdates" class="form-check-label">
                                        <strong>Order Updates</strong>
                                        <br><small class="text-muted">Get notified about order status changes</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input asp-for="MarketingEmails" class="form-check-input" type="checkbox">
                                    <label asp-for="MarketingEmails" class="form-check-label">
                                        <strong>Marketing Emails</strong>
                                        <br><small class="text-muted">Receive promotional offers and newsletters</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input asp-for="ProductRecommendations" class="form-check-input" type="checkbox">
                                    <label asp-for="ProductRecommendations" class="form-check-label">
                                        <strong>Product Recommendations</strong>
                                        <br><small class="text-muted">Get personalized product suggestions</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Regional Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-globe me-2"></i>Regional Settings
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label asp-for="PreferredLanguage" class="form-label">Language</label>
                                <select asp-for="PreferredLanguage" class="form-select">
                                    <option value="en">English</option>
                                    <option value="es">Español</option>
                                    <option value="fr">Français</option>
                                    <option value="de">Deutsch</option>
                                    <option value="it">Italiano</option>
                                    <option value="tr">Türkçe</option>
                                </select>
                                <span asp-validation-for="PreferredLanguage" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="PreferredCurrency" class="form-label">Currency</label>
                                <select asp-for="PreferredCurrency" class="form-select">
                                    <option value="USD">USD ($)</option>
                                    <option value="EUR">EUR (€)</option>
                                    <option value="GBP">GBP (£)</option>
                                    <option value="CAD">CAD (C$)</option>
                                    <option value="TRY">TRY (₺)</option>
                                </select>
                                <span asp-validation-for="PreferredCurrency" class="text-danger"></span>
                            </div>
                            <div class="col-md-4">
                                <label asp-for="TimeZone" class="form-label">Time Zone</label>
                                <select asp-for="TimeZone" class="form-select">
                                    <option value="UTC">UTC</option>
                                    <option value="America/New_York">Eastern Time (ET)</option>
                                    <option value="America/Chicago">Central Time (CT)</option>
                                    <option value="America/Denver">Mountain Time (MT)</option>
                                    <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                    <option value="Europe/London">London (GMT)</option>
                                    <option value="Europe/Paris">Paris (CET)</option>
                                    <option value="Asia/Tokyo">Tokyo (JST)</option>
                                    <option value="Europe/Istanbul">Istanbul (TRT)</option>
                                </select>
                                <span asp-validation-for="TimeZone" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Privacy Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-shield-lock me-2"></i>Privacy Settings
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input asp-for="ProfileVisibility" class="form-check-input" type="checkbox">
                                    <label asp-for="ProfileVisibility" class="form-check-label">
                                        <strong>Public Profile</strong>
                                        <br><small class="text-muted">Allow others to view your public profile</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input asp-for="ShowPurchaseHistory" class="form-check-input" type="checkbox">
                                    <label asp-for="ShowPurchaseHistory" class="form-check-label">
                                        <strong>Show Purchase History</strong>
                                        <br><small class="text-muted">Display your purchase history in your public profile</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input asp-for="AllowDataCollection" class="form-check-input" type="checkbox">
                                    <label asp-for="AllowDataCollection" class="form-check-label">
                                        <strong>Data Collection</strong>
                                        <br><small class="text-muted">Allow us to collect data to improve your experience</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Settings -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-shield-check me-2"></i>Security Settings
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center p-3 border rounded">
                                    <div>
                                        <h6 class="mb-1">Password</h6>
                                        <small class="text-muted">
                                            @if (Model.LastPasswordChange.HasValue)
                                            {
                                                <span>Last changed: @Model.LastPasswordChange.Value.ToShortDateString()</span>
                                            }
                                            else
                                            {
                                                <span>Last changed: Never</span>
                                            }
                                        </small>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#changePasswordModal">
                                        <i class="bi bi-key me-1"></i>Change Password
                                    </button>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center p-3 border rounded">
                                    <div>
                                        <h6 class="mb-1">Two-Factor Authentication</h6>
                                        <small class="text-muted">
                                            @if (Model.TwoFactorEnabled)
                                            {
                                                <span class="text-success">Enabled - Your account is more secure</span>
                                            }
                                            else
                                            {
                                                <span class="text-warning">Disabled - Consider enabling for better security</span>
                                            }
                                        </small>
                                    </div>
                                    <button type="button" class="btn @(Model.TwoFactorEnabled ? "btn-outline-danger" : "btn-outline-success")" id="toggle2FA">
                                        @if (Model.TwoFactorEnabled)
                                        {
                                            <i class="bi bi-shield-slash me-1"></i><span>Disable 2FA</span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-shield-check me-1"></i><span>Enable 2FA</span>
                                        }
                                    </button>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center p-3 border rounded">
                                    <div>
                                        <h6 class="mb-1">Active Sessions</h6>
                                        <small class="text-muted">@Model.ActiveSessions.Count active session(s)</small>
                                    </div>
                                    <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#activeSessionsModal">
                                        <i class="bi bi-list me-1"></i>Manage Sessions
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Danger Zone -->
            <div class="card border-danger mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>Danger Zone
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">Delete Account</h6>
                                    <small class="text-muted">Permanently delete your account and all data. This action cannot be undone.</small>
                                </div>
                                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                                    <i class="bi bi-trash me-1"></i>Delete Account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="changePasswordForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="changePasswordModalLabel">
                        <i class="bi bi-key me-2"></i>Change Password
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="currentPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="newPassword" required>
                        <div class="form-text">Password must be at least 8 characters long</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirmPassword" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle me-1"></i>Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Active Sessions Modal -->
<div class="modal fade" id="activeSessionsModal" tabindex="-1" aria-labelledby="activeSessionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activeSessionsModalLabel">
                    <i class="bi bi-list me-2"></i>Active Sessions
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Session management functionality would be implemented here.</p>
                <div class="list-group">
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">Current Session</h6>
                                <small class="text-muted">Windows • Chrome • This device</small>
                            </div>
                            <span class="badge bg-success">Current</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-danger">Terminate All Other Sessions</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteAccountModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>Delete Account
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>Warning:</strong> This action cannot be undone. All your data will be permanently deleted.
                </div>
                <p>Please type <strong>DELETE</strong> to confirm:</p>
                <input type="text" class="form-control" id="deleteConfirmation" placeholder="Type DELETE">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                    <i class="bi bi-trash me-1"></i>Delete My Account
                </button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .form-check-label {
            cursor: pointer;
        }
        
        .form-switch .form-check-input {
            cursor: pointer;
        }
        
        .card-header h5 {
            color: #495057;
        }
        
        .border-danger .card-header h5 {
            color: white;
        }
        
        .form-label {
            font-weight: 500;
        }
        
        .input-group-text {
            background-color: #f8f9fa;
        }
        
        /* Mobile Responsiveness */
        @@media (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            
            .col-lg-3 {
                margin-bottom: 2rem;
            }
            
            .d-flex.justify-content-between {
                flex-direction: column;
                gap: 1rem;
            }
            
            .d-flex.gap-2 {
                justify-content: stretch;
            }
            
            .d-flex.gap-2 .btn {
                flex: 1;
            }
        }
        
        @@media (max-width: 576px) {
            .modal-lg {
                margin: 1rem;
            }
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Reset form
            $('#resetBtn').on('click', function() {
                if (confirm('Reset all changes?')) {
                    location.reload();
                }
            });
            
            // Change password form
            $('#changePasswordForm').on('submit', function(e) {
                e.preventDefault();
                
                const currentPassword = $('#currentPassword').val();
                const newPassword = $('#newPassword').val();
                const confirmPassword = $('#confirmPassword').val();
                
                if (newPassword !== confirmPassword) {
                    showToast('Passwords do not match', 'error');
                    return;
                }
                
                if (newPassword.length < 8) {
                    showToast('Password must be at least 8 characters long', 'error');
                    return;
                }
                
                // TODO: Implement password change functionality
                showToast('Password changed successfully!', 'success');
                $('#changePasswordModal').modal('hide');
                $('#changePasswordForm')[0].reset();
            });
            
            // Toggle 2FA
            $('#toggle2FA').on('click', function() {
                const isEnabled = $(this).hasClass('btn-outline-danger');
                const action = isEnabled ? 'disable' : 'enable';
                
                if (confirm(`Are you sure you want to ${action} two-factor authentication?`)) {
                    // TODO: Implement 2FA toggle functionality
                    const button = $(this);
                    if (isEnabled) {
                        button.removeClass('btn-outline-danger').addClass('btn-outline-success');
                        button.html('<i class="bi bi-shield-check me-1"></i>Enable 2FA');
                    } else {
                        button.removeClass('btn-outline-success').addClass('btn-outline-danger');
                        button.html('<i class="bi bi-shield-slash me-1"></i>Disable 2FA');
                    }
                    showToast(`Two-factor authentication ${action}d successfully!`, 'success');
                }
            });
            
            // Delete confirmation
            $('#deleteConfirmation').on('input', function() {
                const confirmBtn = $('#confirmDeleteBtn');
                if ($(this).val() === 'DELETE') {
                    confirmBtn.prop('disabled', false);
                } else {
                    confirmBtn.prop('disabled', true);
                }
            });
            
            $('#confirmDeleteBtn').on('click', function() {
                if (confirm('This is your final warning. Your account will be permanently deleted. Continue?')) {
                    // TODO: Implement account deletion functionality
                    showToast('Account deletion request submitted. You will be logged out shortly.', 'success');
                    setTimeout(function() {
                        window.location.href = '/';
                    }, 3000);
                }
            });
            
            // Form validation
            $('#settingsForm').on('submit', function(e) {
                // Additional client-side validation if needed
                showToast('Settings saved successfully!', 'success');
            });
            
            // Phone number formatting
            $('input[name="Phone"]').on('input', function() {
                let value = this.value.replace(/\D/g, '');
                if (value.length >= 10) {
                    value = value.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
                }
                this.value = value;
            });
        });
        
        // Toast notification function
        function showToast(message, type = 'info') {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            if (!$('#toastContainer').length) {
                $('body').append('<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1060;"></div>');
            }
            
            const $toast = $(toastHtml);
            $('#toastContainer').append($toast);
            
            const bsToast = new bootstrap.Toast($toast[0]);
            bsToast.show();
            
            $toast.on('hidden.bs.toast', function() {
                $(this).remove();
            });
        }
    </script>
}
