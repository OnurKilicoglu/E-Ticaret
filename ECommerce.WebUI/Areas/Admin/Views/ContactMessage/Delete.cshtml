@model ContactMessageDeleteViewModel
@{
    ViewData["Title"] = "Delete Contact Message";
}

<!-- Page Header -->
<div class="row mb-4">
    <div class="col-md-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a asp-action="Index">Contact Messages</a>
                </li>
                <li class="breadcrumb-item">
                    <a asp-action="Details" asp-route-id="@Model.Id">Message Details</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">Delete</li>
            </ol>
        </nav>
        <h2 class="mb-0">
            <i class="bi bi-exclamation-triangle text-danger"></i>
            Delete Contact Message
        </h2>
        <p class="text-muted">Confirm deletion of this contact message</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group" role="group">
            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-info">
                <i class="bi bi-eye"></i>
                View Details
            </a>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i>
                Back to List
            </a>
        </div>
    </div>
</div>

<!-- Alert Messages -->
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Main Content -->
<div class="row">
    <!-- Delete Form -->
    <div class="col-lg-8">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-trash-fill"></i>
                    Confirm Message Deletion
                </h5>
            </div>
            <div class="card-body">
                <!-- Warning Message -->
                <div class="alert alert-warning" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>Warning!</strong> You are about to delete this contact message. Please review the details below and confirm your action.
                </div>

                <!-- Message Preview -->
                <div class="border rounded p-3 bg-light mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary mb-2">
                                <i class="bi bi-person-fill"></i>
                                Sender Information
                            </h6>
                            <dl class="row small">
                                <dt class="col-4">Name:</dt>
                                <dd class="col-8"><strong>@Model.Name</strong></dd>
                                
                                <dt class="col-4">Email:</dt>
                                <dd class="col-8">@Model.Email</dd>
                                
                                <dt class="col-4">Subject:</dt>
                                <dd class="col-8">@Model.Subject</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info mb-2">
                                <i class="bi bi-info-circle-fill"></i>
                                Message Status
                            </h6>
                            <dl class="row small">
                                <dt class="col-5">Status:</dt>
                                <dd class="col-7">
                                    <span class="badge bg-@Model.ReadStatusCssClass">
                                        @Model.ReadStatusDisplayName
                                    </span>
                                </dd>
                                
                                <dt class="col-5">Reply Status:</dt>
                                <dd class="col-7">
                                    <span class="badge bg-@Model.ReplyStatusCssClass">
                                        @Model.ReplyStatusDisplayName
                                    </span>
                                </dd>
                                
                                <dt class="col-5">Received:</dt>
                                <dd class="col-7">@Model.CreatedDate.ToString("MMM dd, yyyy")</dd>
                            </dl>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6 class="text-secondary mb-2">
                            <i class="bi bi-chat-text-fill"></i>
                            Message Preview
                        </h6>
                        <div class="border rounded p-3 bg-white">
                            <p class="mb-0 small text-muted">@Model.TruncatedMessage</p>
                        </div>
                    </div>
                </div>

                <!-- Delete Form -->
                <form asp-action="Delete" method="post" novalidate>
                    <input asp-for="Id" type="hidden" />
                    <input asp-for="Name" type="hidden" />
                    <input asp-for="Subject" type="hidden" />
                    
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                    <!-- Delete Type Selection -->
                    <div class="mb-4">
                        <h6 class="text-secondary mb-3">
                            <i class="bi bi-gear-fill"></i>
                            Deletion Type
                        </h6>
                        
                        <div class="form-check mb-3">
                            <input asp-for="HardDelete" class="form-check-input" type="radio" value="false" id="softDelete" checked>
                            <label class="form-check-label" for="softDelete">
                                <strong>Soft Delete (Recommended)</strong>
                                <div class="small text-muted">
                                    Message will be marked as inactive but can be restored later. This is the safer option.
                                </div>
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input asp-for="HardDelete" class="form-check-input" type="radio" value="true" id="hardDelete">
                            <label class="form-check-label" for="hardDelete">
                                <strong class="text-danger">Permanent Delete</strong>
                                <div class="small text-muted text-danger">
                                    Message will be permanently removed from the database and cannot be recovered. Use with caution!
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Reason for Deletion -->
                    <div class="mb-4">
                        <label asp-for="Reason" class="form-label required">
                            <i class="bi bi-chat-square-text"></i>
                            Reason for Deletion
                        </label>
                        <textarea asp-for="Reason" class="form-control" rows="3" 
                                  placeholder="Please provide a reason for deleting this message (e.g., spam, resolved, duplicate, etc.)"></textarea>
                        <span asp-validation-for="Reason" class="text-danger"></span>
                        <div class="form-text">
                            This reason will be logged for audit purposes and may be useful for future reference.
                        </div>
                    </div>

                    <!-- Confirmation Checkbox -->
                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="confirmDelete" required>
                            <label class="form-check-label" for="confirmDelete">
                                <strong>I understand the consequences and want to proceed with deletion</strong>
                            </label>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <div>
                            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                                <i class="bi bi-x-lg"></i>
                                Cancel
                            </a>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-danger" id="deleteBtn" disabled>
                                <i class="bi bi-trash-fill"></i>
                                <span id="deleteBtnText">Delete Message</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Deletion Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-info-circle text-info"></i>
                    Deletion Information
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info small" role="alert">
                    <h6 class="alert-heading">What happens when you delete?</h6>
                    <hr>
                    <p class="mb-2"><strong>Soft Delete:</strong></p>
                    <ul class="mb-3">
                        <li>Message is hidden from normal views</li>
                        <li>Can be restored if needed</li>
                        <li>Maintains data integrity</li>
                        <li>Audit trail is preserved</li>
                    </ul>
                    
                    <p class="mb-2"><strong>Permanent Delete:</strong></p>
                    <ul class="mb-0">
                        <li>Message is completely removed</li>
                        <li>Cannot be recovered</li>
                        <li>Frees up database space</li>
                        <li>Use only when certain</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Message Summary -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-file-text text-secondary"></i>
                    Message Summary
                </h6>
            </div>
            <div class="card-body">
                <dl class="row small">
                    <dt class="col-5">Message ID:</dt>
                    <dd class="col-7">#@Model.Id</dd>
                    
                    <dt class="col-5">From:</dt>
                    <dd class="col-7">@Model.Name</dd>
                    
                    <dt class="col-5">Email:</dt>
                    <dd class="col-7">@Model.Email</dd>
                    
                    <dt class="col-5">Subject:</dt>
                    <dd class="col-7">@Model.Subject</dd>
                    
                    <dt class="col-5">Date:</dt>
                    <dd class="col-7">@Model.CreatedDate.ToString("MMM dd, yyyy")</dd>
                    
                    <dt class="col-5">Status:</dt>
                    <dd class="col-7">
                        <span class="badge bg-@Model.ReadStatusCssClass">
                            @Model.ReadStatusDisplayName
                        </span>
                    </dd>
                    
                    <dt class="col-5">Characters:</dt>
                    <dd class="col-7">@Model.Message.Length</dd>
                </dl>
            </div>
        </div>

        <!-- Alternative Actions -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="bi bi-tools text-warning"></i>
                    Alternative Actions
                </h6>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">
                    Consider these alternatives before deleting:
                </p>
                <div class="d-grid gap-2">
                    <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-eye"></i>
                        Review Message Again
                    </a>
                    
                    @if (Model.IsRead)
                    {
                        <button type="button" class="btn btn-outline-warning btn-sm mark-unread" data-message-id="@Model.Id">
                            <i class="bi bi-envelope"></i>
                            Mark as Unread
                        </button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-outline-success btn-sm mark-read" data-message-id="@Model.Id">
                            <i class="bi bi-envelope-open"></i>
                            Mark as Read
                        </button>
                    }
                    
                    <a href="mailto:@Model.Email?subject=Re: @Uri.EscapeDataString(Model.Subject)" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-reply"></i>
                        Reply via Email
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        $(document).ready(function() {
            // Enable/disable delete button based on confirmation checkbox
            $('#confirmDelete').on('change', function() {
                $('#deleteBtn').prop('disabled', !$(this).prop('checked'));
            });

            // Update delete button text based on deletion type
            $('input[name="HardDelete"]').on('change', function() {
                const isHardDelete = $(this).val() === 'true';
                const btnText = isHardDelete ? 'Permanently Delete Message' : 'Delete Message';
                $('#deleteBtnText').text(btnText);
                
                // Update button class
                const deleteBtn = $('#deleteBtn');
                if (isHardDelete) {
                    deleteBtn.removeClass('btn-danger').addClass('btn-outline-danger');
                } else {
                    deleteBtn.removeClass('btn-outline-danger').addClass('btn-danger');
                }
            });

            // Form submission confirmation
            $('form').on('submit', function(e) {
                const isHardDelete = $('input[name="HardDelete"]:checked').val() === 'true';
                const reason = $('#Reason').val().trim();
                
                if (!reason) {
                    e.preventDefault();
                    alert('Please provide a reason for deletion.');
                    $('#Reason').focus();
                    return false;
                }

                const confirmMessage = isHardDelete 
                    ? 'Are you sure you want to PERMANENTLY delete this message? This action cannot be undone!'
                    : 'Are you sure you want to delete this message? It can be restored later if needed.';

                if (!confirm(confirmMessage)) {
                    e.preventDefault();
                    return false;
                }

                // Show loading state
                const submitBtn = $('#deleteBtn');
                const originalText = submitBtn.html();
                submitBtn.prop('disabled', true).html('<i class="bi bi-hourglass-split"></i> Deleting...');
                
                // Re-enable if form validation fails
                setTimeout(function() {
                    if (submitBtn.prop('disabled') && !$('form').hasClass('was-validated')) {
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                }, 100);
            });

            // Mark as read/unread actions
            $('.mark-read, .mark-unread').on('click', function() {
                const messageId = $(this).data('message-id');
                const action = $(this).hasClass('mark-read') ? 'MarkAsRead' : 'MarkAsUnread';
                
                $.post('@Url.Action("' + action + '")', { id: messageId })
                    .done(function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert('Error: ' + response.message);
                        }
                    })
                    .fail(function() {
                        alert('Error updating message status');
                    });
            });

            // Character count for reason
            $('#Reason').on('input', function() {
                const length = $(this).val().length;
                const maxLength = 500;
                
                if (length > maxLength * 0.8) {
                    $(this).addClass('border-warning');
                } else {
                    $(this).removeClass('border-warning border-danger');
                }
                
                if (length >= maxLength) {
                    $(this).addClass('border-danger').removeClass('border-warning');
                }
            });

            // Auto-focus on reason field
            $('#Reason').focus();
        });
    </script>

    <style>
        .required::after {
            content: " *";
            color: red;
        }
        
        .card.border-danger {
            border-color: #dc3545 !important;
        }
        
        .bg-danger {
            background-color: #dc3545 !important;
        }
        
        .form-check-input:checked[value="true"] + label strong {
            color: #dc3545;
        }
        
        .alert-heading {
            margin-bottom: 0.5rem;
        }
        
        .border-warning {
            border-color: #ffc107 !important;
        }
        
        .border-danger {
            border-color: #dc3545 !important;
        }
        
        dl.row dt {
            font-weight: 500;
        }
    </style>
}
